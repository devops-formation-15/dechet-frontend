
name: frontend-pipline

on:
    push:
        branches:
            - main
    workflow_dispatch:
env:
  VERSION_NUMBER: ${{github.run_number}}
  SERVICE_NAME: ${{vars.SERVICE_NAME}}
  IMAGE_NAME: ${{vars.IMAGE_NAME}}
  DOCKER_COMPOSE_LOCATION: ${{vars.DOCKER_COMPOSE_LOCATION}}
  BUILD_ARGS: ${{vars.BUILD_ARGS}}
jobs:
    test:
        runs-on: ubuntu-latest
        steps:
            - name: copy code source
              run: echo 'test a implementer'

    build:
        needs: test
        runs-on: ubuntu-latest
        steps:
            - name: copy code source
              uses: actions/checkout@v6
            - name: Login to Docker Hub
              uses: docker/login-action@v3
              with:
                  username: ${{ vars.DOCKERHUB_USERNAME }}
                  password: ${{ secrets.DOCKERHUB_TOKEN }}
            - name: build docker image
              run: |
                  echo "BUILD_ARGS raw: '${{ env.BUILD_ARGS }}'"
                  # Remove stray CR characters that may come from Windows-style variables
                  BUILD_ARGS_CLEAN=$(printf '%s' "${{ env.BUILD_ARGS }}" | tr -d '\r')
                  echo "BUILD_ARGS cleaned: '${BUILD_ARGS_CLEAN}'"
                  # Ensure Dockerfile exists in workspace
                  if [ ! -f Dockerfile ]; then
                    echo "Dockerfile not found in workspace:" && ls -la
                    exit 1
                  fi
                  docker build ${BUILD_ARGS_CLEAN} -t ${{env.IMAGE_NAME}}:latest .
            - name: taracbilite de l ancien version
              run: |
                  # Tag the built image with a version tag
                  docker tag ${{env.IMAGE_NAME}}:latest ${{env.IMAGE_NAME}}:v${{env.VERSION_NUMBER}}
            - name: push image
              run: docker push ${{env.IMAGE_NAME}}:latest
            - name: push tagged image
              run: docker push ${{env.IMAGE_NAME}}:v${{env.VERSION_NUMBER}}

    deploy:
        runs-on: ubuntu-latest
        needs: build
        steps:
            - name: Execute remote SSH commands using password
              uses: appleboy/ssh-action@v1
              with:
                  host: ${{ secrets.VPS_HOST }}
                  username: ${{ secrets.VPS_USERNAME }}
                  password: ${{ secrets.VPS_PASSWORD }}
                  script: |
                      cd ${{env.DOCKER_COMPOSE_LOCATION}}
                      echo "pulling backend image..."
                      docker compose pull ${{env.SERVICE_NAME}}
                      echo "running the new image..." 
                      docker compose up -d  --force-recreate ${{env.SERVICE_NAME}}


